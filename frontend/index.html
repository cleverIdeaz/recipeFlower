<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RecipeFlower</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* ... (previous styles remain unchanged) ... */

    /* Updated styles for flower menu and back button */
    .flower-button,
    .back-button {
      background-color: white;
      color: var(--text-color);
      width: 60px;
      height: 60px;
      font-size: 1.5rem;
    }

    /* New styles for scrollable recipe content */
    .recipe-section-content {
      max-height: 300px;
      overflow-y: auto;
      padding-right: 10px;
    }

    /* Styles for the Add Recipe form */
    .add-recipe-form {
      display: none;
      padding: 2rem;
      background-color: var(--card-bg);
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .add-recipe-form h2 {
      margin-bottom: 1rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: var(--bg-color);
      color: var(--text-color);
    }

    .form-group textarea {
      min-height: 100px;
    }

    .submit-button {
      background-color: var(--accent-color);
      color: white;
      border: none;
      padding: 0.75rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }

    .submit-button:hover {
      background-color: var(--hover-color);
    }
  </style>
</head>
<body>
  <div class="container">
    <main class="recipe-card">
      <!-- ... (previous HTML structure remains unchanged) ... -->

      <!-- Add Recipe Form -->
      <div id="addRecipeForm" class="add-recipe-form">
        <h2>Add New Recipe</h2>
        <form id="recipeForm">
          <div class="form-group">
            <label for="recipeName">Recipe Name:</label>
            <input type="text" id="recipeName" name="recipeName" required>
          </div>
          <div class="form-group">
            <label for="category">Category:</label>
            <input type="text" id="category" name="category" required>
          </div>
          <div class="form-group">
            <label for="subcategory">Subcategory:</label>
            <input type="text" id="subcategory" name="subcategory" required>
          </div>
          <div class="form-group">
            <label for="ingredients">Ingredients (one per line, optional link after '|'):</label>
            <textarea id="ingredients" name="ingredients" required></textarea>
          </div>
          <div class="form-group">
            <label for="instructions">Instructions (one per line, optional link after '|'):</label>
            <textarea id="instructions" name="instructions" required></textarea>
          </div>
          <button type="submit" class="submit-button">Add Recipe</button>
        </form>
      </div>
    </main>
  </div>

  <script>
    // ... (previous JavaScript code remains unchanged) ...

    // Update showRecipe function to include scrollable content and handle links
    function showRecipe(recipe) {
      currentRecipe = recipe;
      pageTitle.textContent = recipe.RecipeName;
      pageSubtitle.textContent = `${currentCategory} | ${currentSubcategory}`;
      backButton.style.display = 'block';
      searchInput.style.display = 'none';

      mainContent.innerHTML = `
        <div class="recipe-content">
          <div class="recipe-section">
            <h3>Ingredients</h3>
            <div class="recipe-section-content">
              <ul>
                ${recipe.Ingredients.split('•')
                  .filter(i => i.trim())
                  .map(i => {
                    const [ingredient, link] = i.split('|').map(part => part.trim());
                    return `
                      <li>
                        <input type="checkbox" id="ingredient-${ingredient}">
                        <span>${link ? `<a href="${link}" target="_blank">${ingredient}</a>` : ingredient}</span>
                      </li>
                    `;
                  }).join('')}
              </ul>
            </div>
          </div>
          <div class="recipe-section">
            <h3>Instructions</h3>
            <div class="recipe-section-content">
              <ol>
                ${recipe.Instructions.split('•')
                  .filter(i => i.trim())
                  .map((i, index) => {
                    const [instruction, link] = i.split('|').map(part => part.trim());
                    return `
                      <li>
                        <input type="checkbox" id="instruction-${index}">
                        <span>${link ? `<a href="${link}" target="_blank">${instruction}</a>` : instruction}</span>
                      </li>
                    `;
                  }).join('')}
              </ol>
            </div>
          </div>
        </div>
      `;

      recipePreview.style.display = 'none';
      updateURL();
      loadCheckboxStates();
    }

    // Add functions for handling checkbox states with cookies
    function saveCheckboxStates() {
      const checkboxes = document.querySelectorAll('input[type="checkbox"]');
      const states = {};
      checkboxes.forEach(checkbox => {
        states[checkbox.id] = checkbox.checked;
      });
      document.cookie = `recipeStates_${currentRecipe.RecipeName}=${JSON.stringify(states)}; expires=Fri, 31 Dec 9999 23:59:59 GMT; path=/`;
    }

    function loadCheckboxStates() {
      const cookieName = `recipeStates_${currentRecipe.RecipeName}`;
      const cookie = document.cookie.split('; ').find(row => row.startsWith(cookieName));
      if (cookie) {
        const states = JSON.parse(cookie.split('=')[1]);
        Object.keys(states).forEach(id => {
          const checkbox = document.getElementById(id);
          if (checkbox) {
            checkbox.checked = states[id];
          }
        });
      }
    }

    // Add event listeners for checkbox changes
    mainContent.addEventListener('change', (e) => {
      if (e.target.type === 'checkbox') {
        saveCheckboxStates();
      }
    });

    // Add clear and select all buttons
    function addCheckboxButtons() {
      const buttonContainer = document.createElement('div');
      buttonContainer.innerHTML = `
        <button onclick="selectAllCheckboxes()">Select All</button>
        <button onclick="clearAllCheckboxes()">Clear All</button>
      `;
      mainContent.insertBefore(buttonContainer, mainContent.firstChild);
    }

    function selectAllCheckboxes() {
      document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = true;
      });
      saveCheckboxStates();
    }

    function clearAllCheckboxes() {
      document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
      });
      saveCheckboxStates();
    }

    // Update showRecipe function to add checkbox buttons
    const originalShowRecipe = showRecipe;
    showRecipe = function(recipe) {
      originalShowRecipe(recipe);
      addCheckboxButtons();
    };

    // Add Recipe Form Handling
    function showAddRecipeForm() {
      document.getElementById('addRecipeForm').style.display = 'block';
      mainContent.style.display = 'none';
    }

    function handleAddRecipe(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const newRecipe = {
        RecipeName: formData.get('recipeName'),
        Category: formData.get('category'),
        Subcategory: formData.get('subcategory'),
        Ingredients: formData.get('ingredients').replace(/\n/g, '•'),
        Instructions: formData.get('instructions').replace(/\n/g, '•')
      };

      // Send POST request to your backend
      fetch('/api/recipes', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(newRecipe),
      })
      .then(response => response.json())
      .then(data => {
        console.log('Success:', data);
        // Update local data and UI
        if (!recipeData[newRecipe.Category]) {
          recipeData[newRecipe.Category] = {};
        }
        if (!recipeData[newRecipe.Category][newRecipe.Subcategory]) {
          recipeData[newRecipe.Category][newRecipe.Subcategory] = [];
        }
        recipeData[newRecipe.Category][newRecipe.Subcategory].push(newRecipe);
        showCategories();
        document.getElementById('addRecipeForm').style.display = 'none';
        mainContent.style.display = 'block';
      })
      .catch((error) => {
        console.error('Error:', error);
      });
    }

    document.getElementById('recipeForm').addEventListener('submit', handleAddRecipe);

    // Update handleMenuAction function to show Add Recipe form
    function handleMenuAction(action) {
      switch (action) {
        case 'Add Recipe':
          showAddRecipeForm();
          break;
        // ... (other cases remain unchanged) ...
      }
      flowerMenu.classList.remove('active');
    }

    // Initialize the app
    init();
  </script>
</body>
</html>